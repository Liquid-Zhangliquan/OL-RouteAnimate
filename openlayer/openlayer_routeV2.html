<!DOCTYPE html>
<html>

<head>
    <title>轨迹动画</title>
    <link href="ol.css" rel="stylesheet" type="text/css" />
    <script src="ol-debug.js"></script>
    <script src="turf.min.js"></script>
    <style>
        * {
            padding: 0px;
            margin: 0px;
        }

        #animation {
            z-index: 5000;
            position: absolute;
            left: 150px;
            top: 25px;
        }

        #stop {
            z-index: 5000;
            position: absolute;
            left: 250px;
            top: 25px;
        }

        html,
        body,
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <div id="map">
        <button id="animation">开始</button>
        <button id="stop">停止</button>
    </div>
    <script>
        var layer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://www.google.cn/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i342009817!3m9!2szh-CN!3sCN!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0&token=32965'
            })
        });
        var vector = new ol.layer.Vector({
            source: new ol.source.Vector()
        });

        var lineAnimateLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#ec0404',
                    width: 1
                })
            }),
            Zindex: 999,
            visible: false
        });

        var view = new ol.View({
            center: new ol.proj.fromLonLat([114.56, 30.66]),
            zoom: 13
        });
        var map = new ol.Map({
            layers: [layer, vector, lineAnimateLayer],
            view: view,
            target: "map",
            logo: false
        })

        var lineCoords = [new ol.proj.fromLonLat([114.56, 30.66]), new ol.proj.fromLonLat([114.66, 30.66]), new ol.proj.fromLonLat([114.66, 30.63]), new ol.proj.fromLonLat([114.67, 30.63]), new ol.proj.fromLonLat([114.67, 30.65]), new ol.proj.fromLonLat([114.62, 30.63]), new ol.proj.fromLonLat([114.61, 30.64])];
        var fastLine = new ol.Feature({
            geometry: new ol.geom.LineString(lineCoords)
        });
        vector.getSource().addFeature(fastLine);

        //lineAnimateLayer.getSource().addFeature(fastLine.clone());

        var point = new ol.Feature({
            geometry: new ol.geom.Point(new ol.proj.fromLonLat([114.56, 30.66])),
        });
        point.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                src: "../images/car.png"
            })
        }));
        var origin = point.clone();
        vector.getSource().addFeature(point);

        
        var total_step = 1000;
        var newroute = getRoute(lineCoords, total_step, { units: 'kilometers' })

        function getRoute(coords, total_step, units) {
            var route = {
                "type": "Feature",
                "geometry": {
                    "type": "LineString",
                    "coordinates": coords
                }
            }
            var newcoords = [];
            var total_lineLength = turf.lineDistance(route);
            var per_stepLength = total_lineLength / total_step;
            console.log(total_step, per_stepLength)
            for (let i = 0; i < coords.length - 1; i++) {
                var from = turf.point(coords[i]);
                var to = turf.point(coords[i + 1]);
                let lDistance = turf.distance(from, to, units);
                if (i == 0) {
                    newcoords.push(coords[0])
                }
                if (lDistance > per_stepLength) {
                    let rings = lineMore(from, to, lDistance, per_stepLength, units)
                    newcoords = newcoords.concat(rings)
                } else {
                    newcoords.push(coords[i + 1])
                }
            }
            return newcoords
        }

        function lineMore(from, to, distance, splitLength, units) {
            var step = parseInt(distance / splitLength)
            var leftLength = distance - step * splitLength
            var rings = []
            var route = turf.lineString([from.geometry.coordinates, to.geometry.coordinates])
            for (let i = 1; i <= step; i++) {
                let nlength = i * splitLength
                let pnt = turf.along(route, nlength, { units: 'kilometers' });
                rings.push(pnt.geometry.coordinates)
            }
            if (leftLength > 0) {
                rings.push(to.geometry.coordinates)
            }
            return rings
        }
        
      


        var step = 0.01,
            requestID;
        var key = 0;
        function animation(step) {

            requestID = requestAnimationFrame(function () {
                if (step <= 1) {
                    key++;
                    var second = fastLine.getGeometry().getCoordinateAt(step);
                    var first
                    if (key === 1) {
                        first = origin.getGeometry().getCoordinates();
                    } else {
                        first = point.getGeometry().getCoordinates();
                    }

                    var angle = -Math.atan((second[1] - first[1]) / (second[0] - first[0]));
                    LineAnimate(second, angle);
                    point.getGeometry().setCoordinates(fastLine.getGeometry().getCoordinateAt(step));
                    point.getStyle().getImage().setRotation(angle);
                    step = step + 0.003;
                    animation(step);
                }
            }, 60);
        }

        var precoord, preangle;
        var routePath = [];
        var turnNum = 0;

        function LineAnimate(second, angle) {
            console.log(angle);
            if (!lineAnimateLayer.getVisible()) {
                lineAnimateLayer.setVisible(true)
            }
            if (key === 1) {
                preangle = angle;
                routePath.push(origin.getGeometry().getCoordinates(), second);
                var line = new ol.Feature({
                    geometry: new ol.geom.LineString(routePath)
                });
                lineAnimateLayer.getSource().addFeature(line);
            } else {
                var len = routePath.length;
                if (preangle === angle) {
                    routePath[len - 1] = second;
                    precoord = second;
                } else {
                    turnNum++
                    preangle = angle;
                    routePath.push(second);
                    // var turn = fastLine.getGeometry().getCoordinates()[turnNum];
                    // if (turn) {
                    //     routePath.push(fastLine.getGeometry().getCoordinates()[turnNum]);//添加拐点
                    // } else {
                    //     turn = fastLine.getGeometry().getCoordinates()[turnNum--];
                    //     routePath[len - 1] = fastLine.getGeometry().getCoordinates()[turnNum];//添加拐点
                    // }

                }
            }
            lineAnimateLayer.getSource().getFeatures()[0].getGeometry().setCoordinates(routePath);
        };


        document.getElementById("animation").onclick = function () {
            turnNum = 0;
            key = 0;
            preangle = null;
            routePath = [];
            lineAnimateLayer.getSource().clear();
            animation(step);
        }
        document.getElementById("stop").onclick = function () {
            cancelAnimationFrame(requestID);
        }


        //18417268004
    </script>
</body>

</html>